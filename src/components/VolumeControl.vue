<template>
  <v-list style="overflow: hidden" lines="two">
    <!-- special group volume -->
    <div
      v-if="player.group_childs.length > 0"
      class="volumerow"
      :style="player.powered ? 'opacity: 0.75' : 'opacity: 0.5'"
    >
      <v-btn
        icon
        variant="plain"
        width="60"
        height="30"
        size="x-large"
        @click="api.playerCommandPower(player.player_id, !player.powered)"
      >
        <v-icon icon="mdi-power" />
      </v-btn>
      <span class="text-body-2" style="position: absolute; margin-top: 3px"
        >{{ truncateString(player.display_name, 24) }} +{{
          player.group_childs.length
        }}</span
      >
      <div
        class="text-caption"
        style="
          position: absolute;
          width: 60px;
          text-align: center;
          margin-left: 0px;
        "
      >
        {{ player.group_volume }}
      </div>

      <v-slider
        lazy
        density="compact"
        step="2"
        track-size="2"
        thumb-size="10"
        thumb-label
        :disabled="!player.powered"
        :model-value="Math.round(player.group_volume)"
        style="margin-left: 5px"
        @update:model-value="
          api.queueCommandGroupVolume(player.player_id, $event)
        "
      />
    </div>
    <v-divider
      v-if="player.group_childs.length > 0"
      style="margin-top: 10px; margin-bottom: 10px"
    />

    <div
      v-for="childPlayer in getVolumePlayers(player)"
      :key="childPlayer.player_id"
      class="volumerow"
      :style="childPlayer.powered ? 'opacity: 0.75' : 'opacity: 0.5'"
    >
      <span class="text-body-2">
        <v-btn
          icon
          variant="plain"
          width="60"
          height="30"
          size="x-large"
          style=""
          @click="api.playerCommandPowerToggle(childPlayer.player_id)"
        >
          <v-icon icon="mdi-power" />
        </v-btn>
        <span
          v-if="player.group_childs.includes(childPlayer.player_id)"
          class="text-body-2"
          style="position: absolute; margin-top: 3px"
          >{{ truncateString(childPlayer.name, 27) }}</span
        >
        <span
          v-else
          class="text-body-2"
          style="position: absolute; margin-top: 3px"
          >{{ truncateString(childPlayer.display_name, 27) }}</span
        >
      </span>
      <div
        class="text-caption"
        style="
          position: absolute;
          width: 60px;
          text-align: center;
          margin-left: 0px;
        "
      >
        {{ childPlayer.volume_level }}
      </div>

      <v-slider
        lazy
        density="compact"
        step="2"
        track-size="2"
        thumb-size="10"
        thumb-label
        :disabled="!childPlayer.powered"
        :model-value="Math.round(childPlayer.volume_level)"
        style="margin-left: 5px"
        @update:model-value="
          api.playerCommandVolumeSet(childPlayer.player_id, $event)
        "
      />
    </div>
  </v-list>
</template>

<script setup lang="ts">
import type { Player } from "../plugins/api/interfaces";
import { api } from "../plugins/api";
import { truncateString } from "../utils";

// properties
export interface Props {
  // eslint-disable-next-line vue/require-default-prop
  player: Player;
  smallBtnIcon: {
    button: number;
    icon: number;
  };
}

const props = withDefaults(defineProps<Props>(), {
  smallBtnIcon: () => ({ button: 40, icon: 24 }),
});

const decrement = function (playerId: string, playerCurrentVolume: number) {
  playerCurrentVolume--
  api.queueCommandVolume(playerId, playerCurrentVolume)
};

const increment = function (playerId: string, playerCurrentVolume: number) {
  playerCurrentVolume++
  api.queueCommandVolume(playerId, playerCurrentVolume)
};

const getVolumePlayers = function (player: Player) {
  const items: Player[] = [];
  if (player.group_childs.length == 0) {
    return [player];
  }
  for (const groupChildId of player.group_childs) {
    const volumeChild = api?.players[groupChildId];

    if (volumeChild && volumeChild.available) {
      items.push(volumeChild);
    }
  }
  items.sort((a, b) => (a.name.toUpperCase() > b.name.toUpperCase() ? 1 : -1));
  return items;
};
</script>

<style>

.player-volume-control > div.v-input__prepend {
  margin-inline-end: 0px !important;
}

.player-volume-control > div.v-input__append {
  margin-inline-start: 0px !important;
}

</style>